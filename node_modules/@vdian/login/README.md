### Login

#### 简介

登录通用组件，集成了登录方式校验，获取用户信息，微信静默登录，微信强制登录，登入/登出等功能。

#### 安装

1、使用CDN地址

````html
<script src="//assets.geilicdn.com/v-components/login/"最新版本号"/index.js"></script>
````

2、使用bower

````
bower install http://gitlab.vdian.net/v-components/login.git #master
````

3、npm方式引入

```javascript
//切换至vdian仓库环境
npm set registry http://npm.idcvdian.com

//install
npm install @vdian/login
```

#### 使用源文件

1、直接cdn引入的方式,会在`window`下面创建一个全局的`login`对象，可直接使用该对象，例如：

```javascript
...
login.isLogin();
...
```

2、bower

```javascript
//引用login.js
var  login = require("目录"/login/src/login);
 login.isLogin();
 ...
```

3、npm

```javascript
require("@vdian/login");
```

#### 方法

##### 登录角色校验

`isLogin` 判定当前页面环境是否已经登录（如果有，则默认是买家登录）

【参数】：null

【返回】: true/false

```javascript
var isLogin = login.isLogin();
```

`isSellerLogin`判定是否是纯卖家方式登录（卖家一定是买家，但买家不一定是卖家）

【参数】：null

【返回】: true/false

```javascript
var isSellerLogin = login.isSellerLogin();
```

##### 登录方式校验（支付宝方式的业务场景较少，故暂不考虑）

`isWechatLogin`判定是否是微信方式登录

【参数】：null

【返回】: true/false

```javascript
var isWechatLogin = login.isWechatLogin();
```

`isQQLogin`判定是否是qq方式登录

【参数】：无;

【返回】: true/false

【使用方式】同上

##### 登录环境校验

`isWeixin`判定登录环境是否在微信环境

【参数】：null

【返回】：true/false

```javascript
var isWeixin = login.isWeixin();
```

`isQQ`判定登录环境是否在qq环境

【参数】：null

【返回】：true/false

```javascript
var isQQ = login.isQQ();
```

`isSubAccount`判定登录是否为子账号

【参数】：null

【返回】：true/false

```javascript
var isSubAccount = login.isSubAccount();
```

##### 获取用户信息

`getUserInfo`  调取用户信息数据

【入参】：options对象

|     属性      | 是否必传 |          类型           |           默认值           |                 描述                 |
| :---------: | :--: | :-------------------: | :---------------------: | :--------------------------------: |
| environment |  否   |        Number         | 若不传，则默认解析识别当前页面的url的环境值 | 当前环境值 :0：开发环境；1：日常环境；2：预发环境；3：线上环境 |
|   success   |  否   | void function(result) |          null           |             执行成功后的回调函数             |
|    error    |  否   | void function(result) |          null           |             执行失败后的回调函数             |

`result`对象的数据格式

```json
{"status":
   {"code":0,
    "message":"OK",
    "description":""
   },
 "result":{}
}
```

【返回】：

```json
{
"status":{
 "code":0, //错误码，成功则为0
 "message": "OK",//错误含义
 "description": ""
}
"result":{
"user":{
 "code": //国家码
 "phone"://手机号
}
"buyer":{
 "code": //国家码
 "phone"://手机号
}
"seller":{
 "code": //国家码
 "phone"://手机号
}
"info":{
"headImgUrl"://用户头像
"nickName"://用户昵称
"qqHeadImgUrl"://qq昵称
"qqNickName"://qq头像
"shopID"://店铺id
"shopName"://店铺名称
"shopLogo"://店铺头像
"wxHeadImgUrl"://微信头像
"wxNickName"://微信昵称
}
}
}
```

返回的code类型：

 0 => 请求成功；

 2 => 登录t校验失败；

其他 =>参看[其他错误码](http://wiki.vdian.net/pages/viewpage.action?pageId=1944592#id-统一登录系统接口文档（临时）-常见错误码定义)含义

使用方式

```javascript
login.getUserInfo({
                environment : 0,
                success : function(result){
                    console.log("success:",result);
                },
                error : function(result){
                    console.log("error:",result);
                }
            });
```

`备注：该方法内部统一采取Jsonp格式请求后台的接口数据，兼容IE7+`

##### 是否开过微店（真正卖家）

`isOpenShop` 校验当前登录用户是否有开过微店

【入参】：options

|     属性      | 是否必传 |          类型           |           默认值           |                 描述                 |
| :---------: | :--: | :-------------------: | :---------------------: | :--------------------------------: |
| environment |  否   |        Number         | 若不传，则默认解析识别当前页面的url的环境值 | 当前环境值 :0：开发环境；1：日常环境；2：预发环境；3：线上环境 |
|   success   |  否   | void function(result) |          null           |             执行成功后的回调函数             |
|    error    |  否   | void function(result) |          null           |             执行失败后的回调函数             |

`result`请求返回的数据如下：

```json
{
"status": {
	"code": 0,
	"message": "OK",
	"description": ""
},
"result": {
	"is_shop": 0 //0:未开店；1：有开店
}
}
```

使用方式

```javascript
login.isOpenShop({
                success : function(result){
                    console.log(result);
                },
                error : function(e){
                    console.log(e);
                }
            });
```

##### QQ登录

`qqLogin` qq授权登录

【入参】：options

|     属性      | 是否必传 |   类型   |           默认值           |                描述                 |
| :---------: | :--: | :----: | :---------------------: | :-------------------------------: |
|     url     |  否   | string |  window.location.href   |             目标重定向url              |
| environment |  否   | number | 若不传，则默认解析识别当前页面的url的环境值 | 当前环境值 0：开发环境；1：日常环境；2：预发环境；3：线上环境 |
|   device    |  是   | number |            1            |    指定qq授权登录的设备端 1：mobile；0：pc     |

【返回】: 指定目标的url

##### 微信登录

`wechatSlientLogin`微信静默授权方式登录

【入参】：options

|     属性      | 是否必传 |   类型   |           默认值           |                描述                 |
| :---------: | :--: | :----: | :---------------------: | :-------------------------------: |
|     url     |  否   | string |  window.location.href   |             目标重定向url              |
| environment |  否   | number | 若不传，则默认解析识别当前页面的url的环境值 | 当前环境值 0：开发环境；1：日常环境；2：预发环境；3：线上环境 |

【返回】：指定目标的url

```javascript
login.wechatSlientLogin({environment : 0});
```

`wechatForceLogin`微信强制授权方式登录

【入参】：options(选传)，其参数类型同上

【返回】: 指定目标的url

```javascript
login.wechatForceLogin({environment : 0});
```

`getBindStatus`获取第三方登录用户是否绑定手机

【入参】：options对象

|     属性      | 是否必传 |          类型           |           默认值           |                 描述                 |
| :---------: | :--: | :-------------------: | :---------------------: | :--------------------------------: |
| environment |  否   |        Number         | 若不传，则默认解析识别当前页面的url的环境值 | 当前环境值 :0：开发环境；1：日常环境；2：预发环境；3：线上环境 |
|   success   |  否   | void function(result) |          null           |             执行成功后的回调函数             |
|    error    |  否   | void function(result) |          null           |             执行失败后的回调函数             |

【返回】：result=true 表示**`未绑定手机号`**；result=false 表示**`已绑定手机号`**

```json
{
"status":{
 "code":0, //错误码，成功则为0
 "message": "OK",//错误含义
 "description": ""
}
"result":true/false
}
```

使用方式

```javascript
login.getBindStatus({
  environment: 0,
  success: function(data){
    console.log(data.result);
  },
  error: function(e){
    console.log(e);
  }
});
```

`备注：该方法内部统一采取Jsonp格式请求后台的接口数据，兼容IE7+`

##### 普通登录/注册/登出

`login`登录跳转

【参数】options可选参数配置项

|     属性      | 是否必传 |   类型   |           默认值           |                    描述                    |
| :---------: | :--: | :----: | :---------------------: | :--------------------------------------: |
|     url     |  否   | string |  window.location.href   |                 重定向的url                  |
| environment |  否   | number | 若不传，则默认解析识别当前页面的url的环境值 |               当前环境值；值类型同上                |
|    oauth    |  否   | number |         不传值（显示）         |      是否显示第三方登录； oauth=0不显示；不传参，默认显示      |
|   device    |  否   | number |            1            | 区别h5端或者pc端； h5端：device=1,pc端：device=0`建议手动传值` |
|    force    |  否   | number |        不传值（静默授权）        | 配置微信登录采用静默授权或强制授权；force=1为强制授权，不传，默认静默授权 |
|    bind     |  否   | number |      不传值（不跳转绑定页面）       | 配置第三方登录成功后是否跳转到绑定页面。bind=1 ：表示第三方登录成功后，如果账号未绑定手机号则跳转到绑定页面，绑定成功后跳转回目标页。默认为不跳转到绑定页面。 |
|    nochoice     |  否   | number |      不传值（0）       | 默认展示登录方式选择中间页。nochoice=1 则跳过登录方式选择中间页，直接进入登录页 |
|    seller   |  否   | number |      不传值（买家登录)       | 是否是卖家登录；seller=1 ：卖家登录包含子账号登录功能；seller=0 ：买家登录   |
|    sellerswitchshop   |  否   | number |      -       | 商家登录完是否切换店铺选择页；sellerswitchshop=1 ：登录成功后重定向到店铺选择页   |

【返回】: 指定目标的url

```javascript
login.login({
             environment : 0,
             device : 0
            });
```

`register`注册跳转

【参数】【选传】options

|     属性      | 是否必传 |   类型   |           默认值           |                描述                 |
| :---------: | :--: | :----: | :---------------------: | :-------------------------------: |
|     url     |  否   | string |  window.location.href   |             目标重定向url              |
| environment |  否   | number | 若不传，则默认解析识别当前页面的url的环境值 | 当前环境值 0：开发环境；1：日常环境；2：预发环境；3：线上环境 |

【返回】: 指定目标的url

```javascript
login.register({ environment : 0});
```

`logout`登出跳转

【参数】【选传】options

|     属性      | 是否必传 |   类型   |           默认值           |                描述                 |
| :---------: | :--: | :----: | :---------------------: | :-------------------------------: |
|     url     |  否   | string |  window.location.href   |             目标重定向url              |
| environment |  否   | number | 若不传，则默认解析识别当前页面的url的环境值 | 当前环境值 0：开发环境；1：日常环境；2：预发环境；3：线上环境 |

【返回】: 指定目标的url

```javascript
login.logout({ environment : 0});
```

##### 跳转绑定页面

##### `bind`第三方登录用户跳转绑定手机号页面

【参数】【选传】options

|     属性      | 是否必传 |   类型   |           默认值           |                描述                 |
| :---------: | :--: | :----: | :---------------------: | :-------------------------------: |
|     url     |  否   | string |  window.location.href   |             目标重定向url              |
| environment |  否   | number | 若不传，则默认解析识别当前页面的url的环境值 | 当前环境值 0：开发环境；1：日常环境；2：预发环境；3：线上环境 |

【返回】: 指定目标的url

```javascript
login.bind({
  environment:0
})
```

`备注：该方法仅限第三方登录（微信登录）时并且未绑定手机号时调用，普通登录跳转无效`

#### 技术方案 参见[技术文档](http://gitlab.vdian.net/v-components/login/blob/dev/v1.md)

#### 兼容性处理

- 针对获取登录用户信息的接口，考虑到需要兼容ie7，考虑jsonp的方式跨站请求数据；
- 调取登录用户信息接口采取jsonp统一格式；
- 目前考虑引入第三方库zepto，通过$.ajax()方法来兼容以上两种方式。`废弃`
- 调取是否绑定手机号码接口采取jsonp统一格式；

#### 需求确认点

- 做环境适配（开发、日常、预发、线上）;

- 跳转登录区分h5和pc环境（对应不同的url）;

- 兼容IE浏览器至IE7+,考虑场景：请求用户信息接口涉及到跨域的兼容性处理（IE不兼容CORS方式，考虑使用jsonp方式）;

- 登录校验主要通过cookie方式做判断，将由以下几种类型校验：

  - isLogin:判定是否已经买家登录；对应的cookie字段 islogin,uid,sid,;


- isSellerLogin:是否卖家登录；对应的cookie：sid;


- isWechatLogin:是否微信登录；对应的cookie字段 ;login_source;


- isQQLogin:是否qq登录；cookie字段同上；

#### Changelog

- 0.0.3 修复npm引入方式bug
- 0.1.0 新增了`isWeixin`、`isQQ`、`getBindStatus`、`bind` 等四个方法以及普通登录`login`方法的传参对象`options`新增了`force`、`bind`两个属性 && 代码优化
- 0.3.0 将涉及`location`跳转逻辑的方法统一改为返回url的方式，最后一步跳转逻辑交还给业务方自行处理，具体涉及到目标方法有`qqLogin`、`wechatForceLogin`、`wechatSlientLogin`、`login`、`logout`、`bind`
- 0.4.0 新增查询登录用户是否开店（是否真正卖家）方法 : `isOpenShop`
- 0.5.0 新增sso.weidian.com域名，h5登录及绑定页面地址统一跳转到https://sso.weidian.com/login/index.php
- 0.5.3 账号cookie收敛版本，请参见[Cookie收敛](http://docs.vdian.net/pages/viewpage.action?pageId=74220149)
- 0.5.4 支持多域名("koudai.com", "91ruyu.com", "bibikan.cn")版本
- 0.5.6 新增typescript 文件声明
- 0.5.7 兼容安卓买家版App低于5.5.2.1版本登录操作redirect参数做双重encode，请参见[Cookie收敛](http://docs.vdian.net/pages/viewpage.action?pageId=75259474)
- 0.5.8 新增 `isSubAccount` 方法
- 0.6.0 适配多域名解决方案
- 0.6.6 支持登录完成后跳转到店铺选择页

##### 更多登录相关文档，请参见[H5统一登录](http://fe-docs.vdian.net/common-biz/login.html)
