var gulp = require('gulp'),
    uglify = require('gulp-uglify'),
    del = require('del'),
    rename = require('gulp-rename'),
    banner = require('gulp-banner'),
    eslint = require('gulp-eslint'),
    ejs = require('gulp-ejs'),
    path = require('path'),
    exec = require('child_process').execSync,
    connect = require('gulp-connect'),
    pkg = require('./package.json')

var getCdn = function(env) {
    if (idDev)
        return '../../dist/' + pkg.nickname + '.js';

    switch (env) {
        case 0:
            return '../../dist/' + pkg.nickname + '.js';
        case 1:
            return '//assets.daily.geilicdn.com/v-components/' + pkg.nickname + '/' + pkg.version + '/index.js';
        case 2:
            return '//assets.pre.geilicdn.com/v-components/' + pkg.nickname + '/' + pkg.version + '/index.js';
        case 3:
            return '//assets.geilicdn.com/v-components/' + pkg.nickname + '/' + pkg.version + '/index.js';
    }
}

var src = 'src',
    demo = 'demo',
    build = 'build',
    dist = 'dist',
    static = 'static',
    pages = 'pages',
    environment = 3,
    idDev = 0,
    port = 8988,
    cdn = getCdn(3);

var staticPath = path.join(build, static);


var comment = '';

//clean
gulp.task('clean', function() {
    del.sync(build);
    del.sync(dist);
});
//js
gulp.task('js', function() {
    var target = path.join(dist),
        source = [path.join(src, '**/' + pkg.nickname + '.js')];

    var stream = gulp.src(source);

    stream = stream.pipe(banner(comment, {
        pkg: pkg
    }));

    //output unmin
    stream = stream.pipe(gulp.dest(target));

    //min
    environment && (stream = stream.pipe(uglify()));

    //rename
    stream = stream.pipe(rename(function(path) {
        path.basename += '.min';
    }));

    stream = stream.pipe(banner(comment, {
        pkg: pkg
    }));

    //output min
    stream = stream.pipe(gulp.dest(target));

    //output build
    stream = stream.pipe(rename(function(path) {
        path.basename = 'index';
    }));

    return stream.pipe(gulp.dest(staticPath));
});

//html
gulp.task('html', function() {
    var source = [path.join(demo, '**/*.html')],
        target = path.join(build, pages);

    var stream = gulp.src(source).pipe(ejs({
        cdn: getCdn(environment),
        env: environment
    }));

    return stream.pipe(gulp.dest(target));
});

//eslint
gulp.task('eslint', function() {
    // var source = [path.join(src, '**/' + pkg.nickname + '.js')];
    var source = [path.join(src, '**/*.js')];
    return gulp.src(source)
        .pipe(eslint())
        .pipe(eslint.format());
});

//只生成文档
//docker -i src -o build/pages/docs

//监听文档并生成文档
//docker -i src -o build/pages/docs -w
gulp.task('docs', function(cb) {
    var target = path.join(build, 'pages/docs', 'v' + pkg.version),
        source = path.join(src);
    try {
        exec('docker -i ' + source + ' -o ' + target);
        cb();
    } catch (e) {
        console.log(e.message);
        process.exit(1);
    }
});

gulp.task('default', ['clean'], function() {
    // var tasks = environment == 3 ? ['js'] : ['js', 'html'];
    var tasks = ['js','html'];
    gulp.start.apply(gulp, tasks);
});


gulp.task('watch', ['server'], function() {
    var source = [path.join(src, '**/*.js')];

    gulp.start('default');

    gulp.watch(source, function() {
        gulp.start('js');
    });

    source = [path.join(demo, '**/*.html')];
    gulp.watch(source, function() {
        gulp.start('html');
    });
});

gulp.task('server', function() {
    connect.server({
        host: "127.0.0.1",
        port: port
    });
});

//开发
gulp.task('dev-daily', function() {
    idDev = 1;
    environment = 1;
    gulp.start('watch');
});

gulp.task('dev-pre', function() {
    idDev = 1;
    environment = 2;
    gulp.start('watch');
});

gulp.task('dev-prod', function() {
    idDev = 1;
    environment = 3;
    gulp.start('watch');
});

//发布
gulp.task('daily', function() {
    environment = 1;
    gulp.start('default');
});

gulp.task('pre', function() {
    environment = 2;
    gulp.start('default');
});

gulp.task('prod', function() {
    environment = 3;
    gulp.start('default');
});
