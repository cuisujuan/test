# 开发vbuilder脚手架

## 原理

+   vbuilder 通过 npm 获取脚手架及拉取更新。
+   vbuilder 会将业务目录的文件同步到脚手架目录的 `workspace` 目录。

    这样做的目的是保证业务代码始终位于脚手架目录的子级（[为什么要保证父子关系?](https://github.com/hoperyy/deep-webpack/issues/8)）。

## 从零创建一个脚手架

使用命令：`v scaffold create`

该命令会初始化一个脚手架 demo 供后续开发。

## 查看安装过的脚手架

使用命令：`v show <脚手架名称>`

此命令用于查看脚手架。
    
例如：`v show xxx` 命令会帮你打开 `xxx` 脚手架目录，并在终端展示该目录路径。

## 脚手架对接 vbuilder

+   第一步：创建文件 `vbuilder-entry.js`

    `vbuilder-entry.js` 内容如下：
        
    ```javascript
    require('@vdian/vbuilder-helper')(process)((context) => {
        /* 
         * context: {Object}
         * context.userFolder: {String} 业务目录路径
         * context.srcFolder: {String} 业务目录在脚手架副本里的路径（vbuilder 会将当前目录文件同步到脚手架目录内，用于编译）
         * context.buildFolder: {String} 当前项目编译结果的目录路径
         * context.currentEnv: {String} 用户启动脚手架的任务，例如 vbuilder run daily 命令运行后，context.currentEnv 即为 daily
         * context.debugPort: {Number} vbuilder 提供的调试端口号，默认 9000，如该端口被占用，会自增 1 直到找到空闲的端口号
         */
        
         // 代码
         switch(context.currentEnv) {
            case 'daily':
                break;
            case 'pre':
                break;
            case 'prod':
                break;
            default:
                console.log(`${content.currentEnv} is not supported!`);
                break;
         }
    });
    ```

+   第二步：提供项目 demo 文件

    vbuilder 会读取脚手架根目录中以 `vbuilder-demo` 开头的目录，并将其作为项目初始化的模板。
    
    支持一个或多个模板。
    
    如果脚手架只支持一个模板，可以只创建一个目录：
    
    `vbuilder-demo`（初始化文件置于其中）
    
    如果脚手架支持多个模板，可以在 `vbuilder-demo` 目录下创建多个子目录，作为各种模板，如：
    
    +   `vbuilder-demo/pc`（初始化文件置于其中）
    +   `vbuilder-demo/mobile`（初始化文件置于其中）

+   第三步：将脚手架置于目录：`~/.vbuilder/scaffold` 下，并安装各项依赖

    这样 vbuilder 就可以找到该脚手架了

## 测试脚手架

+   测试模板功能

    进入一个空目录，执行命令：`v init <脚手架名称>`，vbuilder 会拉取 `~/.vbuilder/scaffold` 目录下的脚手架中 `vbuilder-demo/` 下的项目模板

+   测试脚手架编译功能

    通过命令：`v run <taskName>` 启动脚手架任务，执行各种任务

## 发布脚手架

vbuilder 通过 npm 获取脚手架，所以，脚手架的发布也是通过 npm 托管，执行命令 `npm publish` 即可，目前要求脚手架发布到微店源，即带上 `@vdian/` 前缀。

vbuilder 始终会检查脚手架是否有更新，并自动更新最新脚手架。

vbuilder 检查脚手架的原理是检查 npm 源上的最新版本和本地脚手架 `package.json` 内的 `version` 字段比较。

如果脚手架没有发布过，只是在本地测试，vbuilder 会跳过检查更新，便于本地测试。

