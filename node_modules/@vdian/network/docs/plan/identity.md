## 背景

新电商法规定在用户执行某些操作时必须实名认证，不同操作校验有所不同，所以需要在全站增加实名认证校验。

总体设计文档：http://docs.vdian.net/pages/viewpage.action?pageId=79831547

认证场景说明：http://docs.vdian.net/pages/viewpage.action?pageId=80053954

## 方案

实名认证流程图

![image-20190821163429119](https://si.geilicdn.com/img-71810000016cd138b1ac0a21167e-unadjust_571_760.png)

### 方案一 （nginx 动态替换）

**方案：**

1. hawk 拦截 XHR 请求响应，如果符合实名认证条件，则统一处理认证流程，阻断业务代码执行。
2. 在 nginx 集群中，利用 sub-filter 动态替换，详见 [nginx sub-filter 动态替换](http://confluence.vdian.net/pages/viewpage.action?pageId=13999743) 。

```
'<head>' 替换为 '<head><script src="//assets.geilicdn.com/v-components/hawk/$hawk_version/index.js"></script>'

// 替换后页面会在head标签后引入Hawkjs
<html>
<head>
<script src="//assets.geilicdn.com/v-components/hawk/$hawk_version/index.js"></script>
……
```

**优点：**

1. 快速应用到全网任何页面，无须业务方手动引入。
2. 业务方无须关心 hawk 版本升级，hawk 一升级，所有页面均可应用。

**缺点：**

1. 多一个 CDN 请求，但 hawk 为全网覆盖，缓存利用率非常高。
2. **每次发版，需找运维手动配置版本号**。

### 方案二（业务方升级 network 库） `建议`

**方案：**

各业务方引入 network，网络库封装到实名认证处理逻辑，具体实现分为两种：

第一种：network 实现 hawk 拦截 XHR 请求方式，业务无需调用 request 方法，只需引入即可。

```
import '@vdian/network'
```

缺点：

1. 污染了原型，代码复杂度提升。
2. 拦截不了所有的请求，jsonp 拦截有缺陷。

第二种：network 不拦截 XHR 请求，在 request 方法中处理实名认证流程，需要业务方所有请求调用 request 方法。

```
import {request} from '@vdian/network'

// 所有请求需调用request方法
request(url).then(()=>{ })
```

缺点：

1. 业务需将所有请求方法进行改造，成本较高。

**优点：**

1. 由业务方控制，自由度较高。

**缺点：**

1. 需业务引入 network 库，且发布一次。

## 覆盖业务

1. 包含 UGC 操作的页面。
2. 流量较大页面。

## 期望完成时间

9 月 1 日之前
