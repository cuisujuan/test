# API

网络库 API 设计简单，可通过插件机制实现各类复杂逻辑，网络库目前暴露了如下方法。

## create

创建 Network 实例，可传入默认请求参数，通过该方法可创建多个实例，例如上传实例、Thor 实例等。

### 参数

create 方法参数。

| 名称    | 类型   | 默认值       | 是否必填 | 描述                                       |
| ------- | ------ | ------------ | -------- | ------------------------------------------ |
| options | Object | 参照请求参数 | 否       | 传入默认请求参数，作为该实例的默认请求参数 |

### 返回值

返回 Network 实例，实例包括如下属性与方法。

#### options

实例默认请求参数，参照请求参数。

#### hooks

hooks 实例，用于在请求过程中插入钩子函数，方便开发者介入到请求各个过程中。

实例对外暴露 `push` 方法，该方法作用为插入指定钩子函数。

**push 方法参数**

| 名称 | 类型     | 默认值 | 是否必填 | 描述          |
| ---- | -------- | ------ | -------- | ------------- |
| name | String   |        | 是       | hook 名称     |
| fn   | Function |        | 是       | hook 回调函数 |

hook 目前内置下面几种

1. configured：参数序列化以后触发。
2. beforeRequest：在开始发送请求之前触发。
3. beforeSuccess：在请求响应成功接收以后触发。
4. beforeError：在请求响应失败以后触发，包含 JSON 数据解析失败、请求状态未正常返回等。

hook 回调包含两个参数

1. 为请求内部对象，每个 hook 对应不同的对象属性。

    - configured、beforeRequest 为 { request, options }
    - beforeSuccess 为 { request, options, response }
    - beforeError 为 { request, options, response, error }

    request 为 XHR 实例，options 为请求参数，response 为响应数据，error 为错误对象。

2. next 函数

    - 调用 next() 可执行队列中下一个 hook。
    - 调用 next(new Error('错误信息')) 可跳过 hooks 队列。
    - 不调用 next 可终止该钩子后续所有的代码执行。

**示例**

在参数序列化以后添加钩子函数，增加自定义参数。

```
network.use(function(){
    const context = this
    context.hooks.push('configured', function({request,options}, next){
        options.data.custom = '自定义参数'
        next()
    })
})
```

在所有请求之前与之后增加登录判断。

```
network.use(function(){
    const context = this
    context.hooks.push('beforeRequest', function({request,options}, next){
        if(!login.isLogin()){
            return login.login()
        }
        next()
    })
    context.hooks.push('beforeSuccess', function({request,options,response}, next){
        if(response.data && response.data.status.code == 2){
            return login.login()
        }
        next()
    })
})
```

### use

见下面描述。

### request

见下面描述。

## request

request 方法为 thor 实例中暴露的方法，返回 promise，对 thor 请求做了特殊处理，只支持 thor 网关请求。

### 参数

request 方法参数

| 名称    | 类型   | 默认值       | 是否必填 | 描述     |
| ------- | ------ | ------------ | -------- | -------- |
| url     | String |              | 是       | 请求 URL |
| options | Object | 参照请求参数 | 否       | 请求参数 |

请求参数

| 名称            | 类型                            | 默认值              | 是否必填 | 描述                            |
| --------------- | ------------------------------- | ------------------- | -------- | ------------------------------- |
| method          | get/post                        | get                 | 否       | 请求方法                        |
| responseType    | String                          | json                | 否       | 响应类型，参考 XHR responseType |
| withCredentials | Boolean                         | true                | 否       | 是否携带 cookie                 |
| cache           | Boolean                         | false               | 否       | 是否缓存请求                    |
| headers         | Object                          | 参照 headers 默认值 | 否       | 请求头                          |
| data            | Object/FormData/URLSearchParams |                     | 否       | 请求数据                        |
| extra           | Object                          | 参照 extra 默认值   | 否       | 扩展参数，用于特殊场景          |

headers 默认值

```
{
    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
    'Accept': 'application/json, */*'
}
```

extra 默认值

```
{
		// 是否获取设备ID
    deviceId: false
}
```

### 返回值

方法返回 promise，对于请求响应做了规范化处理。

1. 如果请求正常返回且 status.code === 0，则 resolve(response)

    ```
    // 如果api返回响应为 {"status":{"code":0} ……}
    network.request('api').then(function(response){
        // response.status.code === 0 is true
    })
    ```

2. 如果请求正常返回但 status.code !== 0，则 reject(response)。

    ```
    // 如果api返回响应为 {"status":{"code": 不等于0 } ……}
    network.request('api').catch(function(response){
        // response.status.code !== 0 is true
    })
    ```

3. 如果出现网络异常、接口异常或者返回响应不是 JSON，为了统一响应格式，方便业务处理，则 reject( { status: { code: -1 }, result: null } )。

    ```
    network.request('api').catch(function(response){
        // response.status.code === -1 is true
    })
    ```

### 示例

使用 post 请求，响应正常返回。

```
network.request('api',{
    method:'post',
    data:{
        param: {
            id:1
        }
    }
}).then(function(response){
    // 响应正常返回
}).catch(function(errorResponse){
    // 捕获异常响应
})
```

responseType 参数设置无效，thor 请求强制使用 json response type。

```
network.request('api',{
    responseType:'text'
}).then(function(response){
    // response 任然是json
})
```

## use

use 方法为 thor 实例中暴露的方法，该方法可注册插件，实现定制化业务需求，插件注册后即被立即执行。

### 参数

use 方法参数。

| 名称   | 类型     | 默认值 | 是否必填 | 描述     |
| ------ | -------- | ------ | -------- | -------- |
| plugin | Function |        | 是       | 插件函数 |

### 返回值

返回 Network 示例。

### 示例

注册一个插件，增加 get 请求方法，插件函数作用域为 network 实例。

```
network.use(function(){
    // context 为network实例
    const context = this
    // 增加get方法
    context.get = function(url, options){
    	options.method = 'get'
        return context.request(url,options)
    }
})
```

## getDynamicThor

getDynamicThor 将传入的 url 中的 base domain 转为多域名列表中的 base domain

**名词解释**

-   base domain 又名 [eTLD+1](https://web.dev/same-site-same-origin/)
-   多域名列表可见 [WHITE_MULTI_DOMAINS](https://gitlab.vdian.net/v-components/sheer/blob/master/packages/network/src/constants/index.ts)

### 参数

getDynamicThor 方法参数。

| 名称 | 类型   | 默认值 | 是否必填 | 描述                |
| ---- | ------ | ------ | -------- | ------------------- |
| url  | String |        | 是       | thor 接口对应的 url |

### 返回值

替换 base domain 之后的 url

### 转换规则注意：

1. 如果入参 url 不是 thor 接口，则返回原 url
2. 如果当前页面 url 的 base domain 不在多域名列表中，则返回入参

### 示例

假设当前页面地址为 https://youshop01.com/xxx

```
const thor = 'https://thor.weidian.com/api/config/get/1.0'
const dynamicThor = network.use(thor)
// dynamicThor = 'https://thor.youshop01.com/api/config/get/1.0'

const noneThor = 'https://weidian.com/api/config/get/1.0'
const url = network.use(noneThor)
// url = https://weidian.com/api/config/get/1.0
```
