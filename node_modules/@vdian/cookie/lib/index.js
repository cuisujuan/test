import { merge, isNumber, forEach, isDate, isUndef, isEmpty } from '@vdian/util';
import { GLOBAL, COOKIE_DELIMIT, COOKIE_VALUE_DELIMIT, COOKIE_VALUE_REGXP } from './constants/index';
import { normalize } from './normalize/index';
/**
 * 获取cookie
 *
 * 1、可获取当前域名以及父域名下当前路径及父路径cookie。
 * ```
 * const value = cookie.get('a')
 * ```
 * @param name cookie name
 * @returns cookie value 如果匹配不到指定cookie name，则返回undefined
 */
export function get(name) {
    if (isEmpty(name)) {
        return;
    }
    var cookies = GLOBAL.document.cookie.split(COOKIE_DELIMIT);
    var value;
    cookies.some(function (cookie) {
        // get name and value
        var matchs = cookie.match(COOKIE_VALUE_REGXP);
        if (matchs && normalize.get.name(matchs[1]) === name) {
            value = normalize.get.value(matchs[2]);
            return true;
        }
        return false;
    });
    return value;
}
// max-age ie8及以下不支持，为了减少影响面，采用expires
function normalizeExpires(expires) {
    if (isNumber(expires)) {
        expires = new Date(new Date().getTime() + expires * 1000);
    }
    if (isDate(expires)) {
        return expires.toUTCString();
    }
}
/**
 * 设置cookie
 *
 * 1、可设置当前域名及父域名下任何路径cookie。
 * ```
 * // 默认path为'/'
 * cookie.set('b','e')
 * // 设置session cookie，但不建议设置session cookie，部分浏览器退出以后并不会清除
 * cookie.set('b', 'value')
 * ```
 * @param name cookie name
 * @param value cookie value
 * @param opts cookie attributes
 */
export function set(name, value, opts) {
    if (isEmpty(name) || isUndef(value)) {
        return;
    }
    var options = merge({
        path: '/'
        // secure: true,
        // sameSite: 'none'
    }, opts);
    options.expires = normalizeExpires(options.expires);
    var attrs = '';
    forEach(options, function (val, key) {
        if (!val) {
            return;
        }
        // concat attr key
        attrs += COOKIE_DELIMIT + key;
        // if secure is true then set '; secure'
        if (val === true) {
            return;
        }
        // Considers RFC 6265 section 5.2:
        val = val.split(';')[0];
        // concat attr value
        attrs += COOKIE_VALUE_DELIMIT + val;
    });
    // normalize name and value
    name = normalize.set.name(name);
    value = normalize.set.value(value);
    // set cookie
    GLOBAL.document.cookie = name + COOKIE_VALUE_DELIMIT + value + attrs;
}
/**
 * 删除cookie
 *
 * 1、删除规则与set保持一致
 * ```
 * // 删除当前域名cookie
 * cookie.remove('a')
 * ```
 * @param name cookie name
 * @param opts cookie attributes
 */
export function remove(name, opts) {
    set(name, '', merge(opts || {}, {
        expires: -864e5
    }));
}
