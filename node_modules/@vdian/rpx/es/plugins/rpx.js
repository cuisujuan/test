import * as postcss from 'postcss';
import { replaceRpx } from '../util';
import { handleAtRule, keepDecimal, handleDecl } from './util';
import Big from 'big.js';
// 转换单位
function calculate(value, options) {
    var v = new Big(value).div(options.conversionValue).toString();
    return keepDecimal(v) + options.unit;
}
var plugin = postcss.plugin('postcss-rpx', function (opts) {
    var options = Object.assign({
        unit: "rem" /* REM */,
        conversionValue: 100
    }, opts || {});
    return function (root) {
        // 循环css声明
        root.walkDecls(function (decl) {
            handleDecl({ decl: decl }, {
                replace: function (value) {
                    return replaceRpx(value, function (value) {
                        return calculate(value, options);
                    });
                }
            });
        });
        // 循环 @media 规则
        root.walkAtRules('media', function (rule) {
            handleAtRule({ rule: rule }, {
                replace: function (value) {
                    return replaceRpx(value, function (value) {
                        return calculate(value, options);
                    });
                }
            });
        });
    };
});
// 兼容老版本
module.exports = plugin;
export default plugin;
