# 移动端适配方案

## 背景

由于目前适配方案不统一，导致组件无法在各项目中通用，各适配方案无法进行兼容，所以必须统一适配方案，在多次讨论后决定默认采用等比缩放方案（方案在[业界移动端适配方案](./docs/industryi-adaptation.md)有描述）。

## 概述

开发者开发时使用rpx单位，利用CSS插件将rpx单位转换为rem，使用 vw 单位替代 flexible，结合media query 适配指定设备。

## 方案

1. 开发者在开发时，使用设计稿标注的尺寸，单位为rpx，与小程序保持一致，具体见关于开发时单位。

2. 提供postcss 插件，将rpx单位转换为rem单位，以750px设计稿为基准，转换公式为  (原始像素尺寸) rpx / 100，关于转换公式具体见关于rem等份。

   在适配中可供采用的相对单位有rem与vw，由于H5页面需在PC端显示，需为定宽页面，vw单位无法满足需求，所以采用rem作为转换后的单位。

   ```
   // 转换前
   width:75rpx;
   // 转换后
   width:0.75rem;
   ```

3. 提供一份样式文件，添加对html font-size控制。

   - 对于屏幕像素为360、375、414、480、540采取设置固定font-size，解决计算时出现浮点数问题，其余无法整除的屏幕像素交由浏览器进行计算处理，避免位数偏差存在的问题。

   ```
   html{
   	// 解决不支持vw的设备
       font-size: 42.66666666px;
       font-size: 13.33333333vw;
       // 对于屏幕像素为360、375、414、480、540采取设置固定font-size，解决计算时出现浮点数问题
       @media screen and (width: 360px) {
           html {
               font-size: 48px
           }
       }
       @media screen and (width: 375px) {
           html {
               font-size: 50px
           }
       }
       @media screen and (width: 414px) {
           html {
               font-size: 55.2px
           }
       }
       @media screen and (width: 480px) {
           html {
               font-size: 64px
           }
       }
       @media screen and (width: 540px) {
           html {
               font-size: 72px
           }
       }
       // 限制宽度最大值
       @media screen and (min-width: 750px) {
           font-size: 100px
       }
   }
   ```

4. 在body上还原font-size默认大小以及增加最大宽度设置。

   - 由于微店部分H5页面需在PC端显示，限制最大750像素宽度，方便用户浏览。

   ```
   body {
   	// 还原成默认字号
   	font-size: 16px;
   	// 增加最大宽度限制
       max-width: 750px;
       margin:0 auto;
   }
   ```

## 安装与使用

具体见[安装与使用](./docs/installation.md)

## 老项目迁移

为了解决项目临时的开发任务，提供了rem转换rpx插件用于转换老项目。

1. 如果项目中使用的是同一套rem（10、20、25）方案，则只需在项目根目录下新建 postcss.config.js，配置内容如下：

   ```
   // 在 10、20、25 rem等份下，fontSize 分别对应 75、37.5、30
   module.exports = {
     plugins: [
     	// 该插件配置在rpx插件之前
       require('@vdian/rpx/lib/plugins/rem')({
       	fontSize: 75
       })
     ]
   }
   ```

2. 如果项目中使用的不是同一套，则需要在各 pages 目录下新建 postcss.config.js，设置对应fontSize，配置内容参照上面。

**rem插件只是临时性解决问题，对于有迭代的项目必须从源码层面进行迁移。**

## 方案补充

### 关于开发时单位

在开发时的单位抉择时，我们考量了大量单位与方案，经过了多次讨论，最终决定使用rpx作为开发时单位，下面是px、vw、rem、rpx单位的比较。

#### 使用px单位

**缺点**

1. 如果部分样式需使用px单位，则需通过标记进行忽略。
2. 带来理解成本，需理解此时的px所代替的含义，此时的px其实为相对单位。
3. 不利于后续升级。
   - 替换成到其他适配方案。
   - 设计稿基准值变化。

#### 使用vw单位

**缺点**

1. 如部分样式需使用vw单位，则需通过标记进行忽略。
2. 带来理解成本，需理解此时的vw所代替的含义。
3. 目前设计稿采用的是像素单位，开发时需将px转换为vw，会出现无法除尽的浮点数。
4. 不利于后续升级。

#### 使用rem单位

**缺点**

1. 目前设计稿采用的是像素单位，开发时需按照指定的等份将px转换为rem
   - 不利于等份的统一管理。
2. 不利于后续升级。

#### 使用rpx单位

rpx单位与小程序一致，可以根据屏幕宽度进行自适应。具体见 [rpx](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxss.html)

**优点**

1. 与px区分，方便理解。
2. 与小程序保持一致，方便样式文件进行迁移。
3. 无需换算，直接使用设计稿尺寸。

**缺点**

1. 增加rpx理解成本。
2. 不利于后续升级，但相比前两者，只需将rpx单位进行换算即可。

### 关于rem等份

按照750宽设计稿基准，rem的方案为 (尺寸 /  (750/等份) ) * html font size

1. 由于 html font size最小只能为12px，按照目前最小屏幕像素为320px计算，等份不能大于26。
2. 由于尺寸不定，750/等份 需为一个可以被任意数除尽的数且不能大于26，否则在375屏幕下将出现浮点数，由此得到 100 最合适。
3. 所以得到等份为7.5份，所有尺寸除以100，均能被除尽，在iPhone 6下，font-size 为50px。

